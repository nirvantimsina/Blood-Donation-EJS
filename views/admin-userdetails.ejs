<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | BloodDonorNepal</title>
    <link rel="icon" type="image/svg+xml" href="/images/blood-donor.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    <script src="https://cdn.maptiler.com/maptiler-geocoding-control/v2.1.4/maptilersdk.umd.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-geocoding-control/v2.1.4/style.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a209b08554.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .stat-card {
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .navbar-brand {
            font-weight: 600;
        }

        .map-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-container .form-control,
        .form-container .form-select {
            width: 100%;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.35em 0.65em;
        }

        .approved {
            background-color: #198754;
        }

        .pending {
            background-color: #fd7e14;
        }

        .rejected {
            background-color: #dc3545;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="bi bi-droplet-fill me-2"></i>BloodDonorNepal Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/users">
                            <i class="bi bi-people me-1"></i>Manage Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/blood-requests">
                            <i class="bi bi-heart-pulse me-1"></i>Blood Requests
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="profileDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i>
                            <%= admin.fullName || 'Admin' %>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                            <li><a class="dropdown-item" href="/admin/profile">
                                    <i class="bi bi-person me-2"></i>My Profile
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="/logout">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Alerts Section -->
        <% if (message) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                <%= message %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <% } %>

                <% if (error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <% } %>
    </div>

    <div class="container my-4">
        <h3 class="mb-4"><i class="bi bi-person-lines-fill me-2"></i>User Details</h3>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="card shadow-sm mb-3">
                    <img src="<%= user.userImage %>" class="card-img-top" alt="User Image">
                    <div class="card-body">
                        <img src="<%= user.bloodDetails.bloodGroupImage %>" class="img-fluid mb-3" alt="Blood Group">
                        <h5 class="card-title">
                            <span class="badge bg-primary">
                                <%= user.bloodDetails.bloodGroupType %>
                            </span>
                        </h5>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="form-container">
                    <form method="POST" action="/admin/users/<%= user._id %>/update">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" value="<%= user.fullName %>" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" value="<%= user.email %>" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact Number</label>
                            <input type="text" class="form-control" value="<%= user.contactNumber %>" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Disease</label>
                            <input name="disease" type="text" class="form-control"
                                value="<%= user.bloodDetails.disease === 'none' ? 'none' : user.bloodDetails.disease %>">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Can Donate</label>
                            <select name="canDonate" class="form-select">
                                <option value="true" <%=user.bloodDetails.canDonate ? 'selected' : '' %>>Yes</option>
                                <option value="false" <%=!user.bloodDetails.canDonate ? 'selected' : '' %>>No</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Can Receive</label>
                            <select name="canReceive" class="form-select">
                                <option value="true" <%=user.bloodDetails.canReceive ? 'selected' : '' %>>Yes</option>
                                <option value="false" <%=!user.bloodDetails.canReceive ? 'selected' : '' %>>No</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Approval Status</label>
                            <select name="approved" class="form-select">
                                <option value="true" <%=user.approved ? 'selected' : '' %>>Approved</option>
                                <option value="false" <%=!user.approved ? 'selected' : '' %>>Not Approved</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary me-md-2">
                                <i class="bi bi-save-fill me-1"></i>Update
                            </button>
                            <a href="/admin/users" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back to Users
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <% if (user.location && user.location.latitude && user.location.longitude) { %>
            <div class="my-5">
                <h5><i class="bi bi-geo-alt-fill me-2"></i>User Location</h5>
                <input type="hidden" id="userLocation" data-lat="<%= user.location.latitude %>"
                    data-lng="<%= user.location.longitude %>">
                <div class="map-container mt-3" id="map"></div>
            </div>
            <% } else { %>
                <div class="alert alert-info mt-5">
                    <i class="bi bi-info-circle-fill me-2"></i>No location data available for this user
                </div>
                <% } %>
    </div>

    <!-- Load Bootstrap JS bundle -->


    <script>
        // Initialize map after everything loads
        document.addEventListener('DOMContentLoaded', function () {
            const userLocationEl = document.getElementById('userLocation');

            if (userLocationEl && typeof maptilersdk !== 'undefined') {
                try {
                    // Set your MapTiler API key
                    maptilersdk.config.apiKey = 'wVy9Sy9TsKoqEYgTM9ha';

                    const userLocation = {
                        lat: parseFloat(userLocationEl.dataset.lat),
                        lng: parseFloat(userLocationEl.dataset.lng)
                    };
                    console.log("ram", typeof maptilersdk)

                    // Create the map
                    const map = new maptilersdk.Map({
                        container: 'map',
                        style: maptilersdk.MapStyle.STREETS,
                        center: [userLocation.lng, userLocation.lat],
                        zoom: 15
                    });

                    // Add marker for user location
                    new maptilersdk.Marker({ color: "#dc3545" })
                        .setLngLat([userLocation.lng, userLocation.lat])
                        .addTo(map);

                    // Add zoom controls
                    map.addControl(new maptilersdk.NavigationControl(), 'top-right');

                } catch (error) {
                    console.error('Map initialization error:', error);
                    document.getElementById('map').innerHTML =
                        '<div class="alert alert-warning p-3">Could not load map. Please try again later.</div>';
                }
            }
        });
    </script>
</body>

</html>